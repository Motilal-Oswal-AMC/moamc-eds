# AEM Edge Delivery Services - CI/CD Workflow
# Complements the built-in AEM Code Sync PSI checks
# Based on: https://www.aem.live/docs/dev-collab-and-good-practices

name: Build & Quality Checks

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Build & Lint (Your existing workflow)
  # ============================================
  build:
    name: üî® Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run Stylelint (CSS)
        run: npm run lint:css

  # ============================================
  # Job 2: Code Quality Checks
  # ============================================
  code-quality:
    name: üìä Code Quality
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Check for console.log statements
        run: |
          echo "üîç Checking for console.log statements..."
          FOUND=$(grep -rn "console\.log" --include="*.js" blocks/ scripts/ 2>/dev/null | grep -v "// eslint-disable" || true)
          if [ -n "$FOUND" ]; then
            echo "‚ö†Ô∏è  Warning: console.log statements found:"
            echo "$FOUND"
            echo ""
            echo "Consider removing before production."
          else
            echo "‚úÖ No console.log statements found."
          fi

      - name: Check for debugger statements
        run: |
          echo "üîç Checking for debugger statements..."
          if grep -rn "debugger" --include="*.js" blocks/ scripts/ 2>/dev/null; then
            echo "‚ùå Error: debugger statements found!"
            exit 1
          else
            echo "‚úÖ No debugger statements found."
          fi

      - name: Validate JSON files
        run: |
          echo "üîç Validating JSON files..."
          ERRORS=0
          for file in $(find . -name "*.json" -not -path "./node_modules/*"); do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚ùå Invalid JSON: $file"
              ERRORS=$((ERRORS+1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi
          echo "‚úÖ All JSON files are valid."

      - name: Check file sizes
        run: |
          echo "üîç Checking for large files..."
          MAX_JS_SIZE=50000   # 50KB
          MAX_CSS_SIZE=30000  # 30KB
          WARNINGS=0
          
          for file in $(find blocks scripts -name "*.js" 2>/dev/null || true); do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              if [ "$size" -gt "$MAX_JS_SIZE" ]; then
                echo "‚ö†Ô∏è  Large JS: $file ($(($size/1024))KB)"
                WARNINGS=$((WARNINGS+1))
              fi
            fi
          done
          
          for file in $(find blocks styles -name "*.css" 2>/dev/null || true); do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              if [ "$size" -gt "$MAX_CSS_SIZE" ]; then
                echo "‚ö†Ô∏è  Large CSS: $file ($(($size/1024))KB)"
                WARNINGS=$((WARNINGS+1))
              fi
            fi
          done
          
          if [ $WARNINGS -eq 0 ]; then
            echo "‚úÖ All files within size limits."
          fi

  # ============================================
  # Job 3: Security Audit
  # ============================================
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      - name: Run npm audit
        run: |
          echo "üîç Checking for vulnerabilities..."
          npm audit --audit-level=high
          echo ""
          echo "‚ÑπÔ∏è  High/Critical vulnerabilities will be flagged."

  # ============================================
  # Job 4: PR Validation (PRs only)
  # ============================================
  pr-validation:
    name: üìù PR Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR description for preview URL
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          echo "üîç Validating PR description..."
          
          # Check if PR body is empty
          if [ -z "$PR_BODY" ]; then
            echo "‚ùå PR description is empty!"
            echo ""
            echo "üìå Best Practice: Include preview URLs for reviewers"
            echo "   Example: https://branch--DTIN-NipponAmc-Website-EDS--dept.aem.page/"
            exit 1
          fi
          
          # Check for AEM preview URL
          if echo "$PR_BODY" | grep -qE "(aem\.page|aem\.live|hlx\.page|hlx\.live)"; then
            echo "‚úÖ Preview URL found in PR description."
          else
            echo "‚ö†Ô∏è  No AEM preview URL found in PR description."
            echo ""
            echo "üìå Best Practice: Include a URL where reviewers can test your changes:"
            echo "   https://<branch>--DTIN-NipponAmc-Website-EDS--dept.aem.page/"
            echo ""
            echo "   This helps reviewers see your changes in action!"
          fi

      - name: Remind about AEM PSI Check
        run: |
          echo ""
          echo "üìä Reminder: AEM Code Sync automatically runs PageSpeed Insights"
          echo "   ‚úì Look for 'aem-psi-check' status on this PR"
          echo "   ‚úì Target: Lighthouse score of 100 for mobile & desktop"
          echo "   ‚úì PR will fail if score drops significantly"
          echo ""
          echo "üîó Manual check: https://pagespeed.web.dev/"

  # ============================================
  # Job 5: Accessibility Quick Check
  # ============================================
  accessibility:
    name: ‚ôø Accessibility Check
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Check for common accessibility issues in code
        run: |
          echo "üîç Checking for common accessibility patterns..."
          ISSUES=0
          
          # Check for images without alt in HTML/JS
          echo ""
          echo "üì∑ Checking image alt attributes..."
          MISSING_ALT=$(grep -rn '<img' --include="*.html" --include="*.js" blocks/ scripts/ 2>/dev/null | grep -v 'alt=' || true)
          EMPTY_ALT=$(grep -rn '<img' --include="*.html" --include="*.js" blocks/ scripts/ 2>/dev/null | grep -E "alt=(\"\"|\'\')" || true)
          if [ -n "$MISSING_ALT" ] || [ -n "$EMPTY_ALT" ]; then
            if [ -n "$MISSING_ALT" ]; then
              echo "‚ö†Ô∏è  Possible images without alt attribute:"
              echo "$MISSING_ALT"
            fi
            if [ -n "$EMPTY_ALT" ]; then
              echo "‚ö†Ô∏è  Images with empty alt attribute (ensure these are decorative only):"
              echo "$EMPTY_ALT"
            fi
            ISSUES=$((ISSUES+1))
          else
            echo "‚úÖ All img tags appear to have non-empty alt attributes."
          fi
          
          # Check for buttons without accessible names
          echo ""
          echo "üîò Checking button accessibility..."
          EMPTY_BUTTONS=$(grep -rn '<button>' --include="*.html" --include="*.js" blocks/ 2>/dev/null | grep -v 'aria-label' || true)
          if [ -n "$EMPTY_BUTTONS" ]; then
            echo "‚ö†Ô∏è  Check these buttons have accessible names:"
            echo "$EMPTY_BUTTONS"
          fi
          
          # Check for proper ARIA usage
          echo ""
          echo "üè∑Ô∏è  Checking ARIA attributes..."
          ARIA_HIDDEN=$(grep -rn 'aria-hidden="true"' --include="*.js" blocks/ 2>/dev/null | head -5 || true)
          if [ -n "$ARIA_HIDDEN" ]; then
            echo "‚ÑπÔ∏è  Found aria-hidden usage (verify it's correct):"
            echo "$ARIA_HIDDEN"
          fi
          
          echo ""
          echo "‚ÑπÔ∏è  Full accessibility testing done by AEM PSI check (Lighthouse)."

  # ============================================
  # Summary
  # ============================================
  summary:
    name: üìã Summary
    runs-on: ubuntu-latest
    needs: [build, code-quality, security, pr-validation, accessibility]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Generate Summary
        run: |
          echo "## üéØ CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Lint | ${{ needs.build.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Check Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Review Needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Validation | ${{ needs.pr-validation.result == 'success' && '‚úÖ Passed' || (needs.pr-validation.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ö†Ô∏è Add Preview URL') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility.result == 'success' && '‚úÖ Passed' || (needs.accessibility.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ö†Ô∏è Review Needed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîî Don't forget!" >> $GITHUB_STEP_SUMMARY
          echo "- Check **aem-psi-check** status for Lighthouse scores" >> $GITHUB_STEP_SUMMARY
          echo "- Target: **100** for Performance, Accessibility, SEO, Best Practices" >> $GITHUB_STEP_SUMMARY